<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>足跡百景 - デモ</title>
    <!-- Tailwind CSS (デザインを整える) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet.js (地図ライブラリ) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; }
        /* ヘッダーとフッターの高さを考慮して、地図の高さを調整 */
        #map { height: calc(100vh - 320px); width: 100%; border-radius: 0.5rem; border: 1px solid #e2e8f0; }
        .hidden { display: none; }
        /* ローディングスピナー */
        .loader { border-top-color: #3498db; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- ローディング画面 -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div>
        <p class="text-white text-2xl absolute">処理中...</p>
    </div>

    <!-- ログイン画面 (変更なし) -->
    <div id="login-section" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-2xl shadow-lg w-full max-w-md">
            <h1 class="text-3xl font-bold text-center text-green-600 mb-2">足跡百景</h1>
            <p class="text-center text-gray-500 mb-6">ログインして、お絵かきを始めよう</p>
            <input type="email" id="login-email" placeholder="メールアドレス" class="w-full p-3 mb-4 border rounded-lg" value="">
            <input type="password" id="login-password" placeholder="パスワード" class="w-full p-3 mb-4 border rounded-lg" value="">
            <button id="login-button" class="w-full bg-green-500 hover:bg-green-600 text-white p-3 rounded-lg font-bold">ログイン</button>
            <p id="login-error" class="text-red-500 mt-4 text-center h-4"></p>
            <p class="text-center text-sm text-gray-500 mt-4">
              アカウントがない場合は <a href="/register.html" class="font-semibold text-blue-500 hover:underline">新規登録</a>
            </p>
        </div>
    </div>

    <!-- 地図・お絵かき画面 (ヘッダーとフッターを追加) -->
    <div id="map-section" class="hidden flex flex-col min-h-screen">
        <!-- ★★★ ここからヘッダー ★★★ -->
        <header class="bg-[#14BE6F] text-white p-4 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold">足跡百景</h1>
                <div>
                    <span id="user-name-display" class="mr-4 text-sm font-semibold"></span>
                    <button id="logout-button" class="bg-white/20 hover:bg-white/30 p-2 rounded text-sm font-semibold">ログアウト</button>
                </div>
            </div>
        </header>
        <!-- ★★★ ヘッダーここまで ★★★ -->

        <main class="container mx-auto p-4 flex-grow">
            <div class="bg-white p-6 rounded-lg shadow-md h-full flex flex-col">
                <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-4">
                    <button id="start-button" class="w-full sm:w-auto bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105">お絵かきスタート</button>
                    <button id="stop-button" class="w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105" disabled>ストップ＆画像生成</button>
                </div>
                <div id="map" class="flex-grow"></div>
                <div id="result-area" class="mt-4 text-center"></div>
            </div>
        </main>

        <!-- ★★★ ここからフッター ★★★ -->
        <footer class="bg-gray-800 text-white p-4 shadow-inner">
            <div class="container mx-auto flex justify-center items-center gap-6 text-sm">
                <a href="#" class="hover:text-green-400 font-semibold">足跡百景</a>
                <a href="#" class="hover:text-green-400">書く</a>
                <a href="#" class="hover:text-green-400">なぞり型</a>
                <a href="#" class="hover:text-green-400">マイページ</a>
            </div>
        </footer>
        <!-- ★★★ フッターここまで ★★★ -->
    </div>

<script>
    // --- (JavaScript部分は変更ありません) ---
    const API_BASE_URL = 'http://163.43.104.210/gps_art_app/api';
    let map, polyline, token = null, isDrawing = false, currentArtworkId = null;
    let points = [];
    let watchId = null;
    let currentUserMarker = null;

    const loginSection = document.getElementById('login-section');
    const mapSection = document.getElementById('map-section');
    const loadingOverlay = document.getElementById('loading-overlay');
    
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-button').addEventListener('click', handleLogin);
        document.getElementById('logout-button').addEventListener('click', handleLogout);
        document.getElementById('start-button').addEventListener('click', handleStartDrawing);
        document.getElementById('stop-button').addEventListener('click', handleStopDrawing);
    });
    
    const showLoading = () => loadingOverlay.classList.remove('hidden');
    const hideLoading = () => loadingOverlay.classList.add('hidden');

    async function apiFetch(endpoint, options = {}) {
        showLoading();
        try {
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            const response = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, headers });
            const result = await response.json();
            if (!response.ok) throw new Error(result.error || '不明なエラー');
            return result;
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        } finally {
            hideLoading();
        }
    }

    async function handleLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const errorEl = document.getElementById('login-error');
        errorEl.textContent = '';

        try {
            const data = await apiFetch('/login.php', {
                method: 'POST',
                body: JSON.stringify({ email, password })
            });
            token = data.token;
            loginSection.classList.add('hidden');
            mapSection.classList.remove('hidden');
            document.getElementById('user-name-display').textContent = `ようこそ、${data.user.user_name}さん`;
            initMap();
        } catch (error) {
            errorEl.textContent = error.message;
        }
    }

    function handleLogout() {
        token = null;
        loginSection.classList.remove('hidden');
        mapSection.classList.add('hidden');
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
    }
    
    function initMap() {
        if (map) {
             map.remove();
        }
        map = L.map('map').setView([34.07, 134.55], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        currentUserMarker = L.circleMarker([0,0], { radius: 8, color: 'blue', fillColor: '#3498db', fillOpacity: 0.8 }).addTo(map);

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const latLng = [pos.coords.latitude, pos.coords.longitude];
                map.setView(latLng, 16);
                currentUserMarker.setLatLng(latLng);
            },
            () => console.warn('現在地を取得できませんでした。'),
            { enableHighAccuracy: true }
        );

        polyline = L.polyline([], { color: '#14BE6F', weight: 5 }).addTo(map);
    }

    async function handleStartDrawing() {
        try {
            const data = await apiFetch('/create_artwork.php', { method: 'POST' });
            currentArtworkId = data.artwork_id;
            points = [];
            polyline.setLatLngs([]);
            document.getElementById('result-area').innerHTML = '';
            
            if (!navigator.geolocation) {
                alert('お使いのブラウザはGPS機能に対応していません。');
                return;
            }

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const latLng = [lat, lng];
                    currentUserMarker.setLatLng(latLng);
                    map.panTo(latLng);
                    if (isDrawing) {
                        const newPoint = { latitude: lat, longitude: lng };
                        points.push(newPoint);
                        polyline.addLatLng(latLng);
                    }
                },
                (error) => {
                    console.error("GPS Error:", error.message);
                    alert("GPSの測位に失敗しました。場所の権限が許可されているか確認してください。");
                    handleStopDrawing();
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );

            isDrawing = true;
            document.getElementById('start-button').disabled = true;
            document.getElementById('stop-button').disabled = false;
            alert(`お絵かきを開始しました！(作品ID: ${currentArtworkId})`);

        } catch (error) {
            alert(`エラー: ${error.message}`);
        }
    }

    async function handleStopDrawing() {
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
            watchId = null;
        }
        
        if (!isDrawing) return;
        isDrawing = false;
        
        if (points.length < 2) {
            alert('軌跡が短すぎます。');
            document.getElementById('start-button').disabled = false;
            document.getElementById('stop-button').disabled = true;
            return;
        }
        
        try {
            const data = await apiFetch('/finalize_artwork.php', {
                method: 'POST',
                body: JSON.stringify({ artwork_id: currentArtworkId, points: points })
            });

            document.getElementById('start-button').disabled = false;
            document.getElementById('stop-button').disabled = true;
            
            const resultArea = document.getElementById('result-area');
            const imageUrl = `http://${location.hostname}${data.image_url}`;
            resultArea.innerHTML = `
                <h3 class="text-lg font-bold">作品が完成しました！</h3>
                <img src="${imageUrl}" class="mt-2 border shadow-lg mx-auto" alt="完成した作品">
                <p class="text-sm text-gray-500 mt-2">画像のURL: <a href="${imageUrl}" target="_blank" class="text-blue-500">${imageUrl}</a></p>
            `;
            
        } catch (error) {
            alert(`保存エラー: ${error.message}`);
        }
    }
</script>
</body>
</html>

