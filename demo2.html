<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>足跡百景 - デモ</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet.js (地図ライブラリ) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: sans-serif; }
        #map { height: calc(100vh - 200px); width: 100%; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="text-white text-2xl">処理中...</div>
    </div>

    <!-- ログイン・登録セクション -->
    <div id="auth-section" class="container mx-auto p-4 max-w-md">
        <div class="bg-white p-8 rounded-lg shadow-md">
            <h1 class="text-2xl font-bold text-center text-green-600 mb-6">足跡百景</h1>
            
            <!-- ログインフォーム -->
            <div id="login-form">
                <h2 class="text-xl mb-4">ログイン</h2>
                <input type="email" id="login-email" placeholder="メールアドレス" class="w-full p-2 mb-4 border rounded">
                <input type="password" id="login-password" placeholder="パスワード" class="w-full p-2 mb-4 border rounded">
                <button id="login-button" class="w-full bg-green-500 hover:bg-green-600 text-white p-2 rounded">ログイン</button>
                <p class="text-center mt-4">アカウントがない場合は<a href="#" id="show-register" class="text-blue-500">新規登録</a></p>
            </div>

            <!-- 新規登録フォーム (最初は非表示) -->
            <div id="register-form" class="hidden">
                <h2 class="text-xl mb-4">新規登録</h2>
                <input type="text" id="register-name" placeholder="ユーザー名" class="w-full p-2 mb-4 border rounded">
                <input type="email" id="register-email" placeholder="メールアドレス" class="w-full p-2 mb-4 border rounded">
                <input type="password" id="register-password" placeholder="パスワード" class="w-full p-2 mb-4 border rounded">
                <button id="register-button" class="w-full bg-blue-500 hover:bg-blue-600 text-white p-2 rounded">登録</button>
                <p class="text-center mt-4">アカウントをお持ちの場合は<a href="#" id="show-login" class="text-blue-500">ログイン</a></p>
            </div>
            <p id="auth-error" class="text-red-500 mt-4 text-center"></p>
        </div>
    </div>

    <!-- 地図・お絵かきセクション (最初は非表示) -->
    <div id="map-section" class="hidden">
        <header class="bg-white p-4 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-xl font-bold text-green-600">足跡百景 - お絵かきモード</h1>
                <div>
                    <span id="user-name-display" class="mr-4"></span>
                    <button id="logout-button" class="bg-gray-200 p-2 rounded">ログアウト</button>
                </div>
            </div>
        </header>
        <div class="container mx-auto p-4">
            <div class="bg-white p-4 rounded-lg shadow-md">
                <div class="flex justify-center items-center space-x-4 mb-4">
                    <button id="start-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">お絵かきスタート</button>
                    <button id="stop-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded" disabled>ストップ</button>
                </div>
                <div id="map"></div>
                <div id="result-area" class="mt-4 text-center"></div>
            </div>
        </div>
    </div>

<script>
    // --- ★★★ 設定項目 ★★★ ---
    const API_BASE_URL = 'http://163.43.104.210/gps_art_app/api'; // あなたのサーバーIPアドレスに書き換えてください

    // --- グローバル変数 ---
    let map;
    let polyline;
    let token = null;
    let isDrawing = false;
    let currentArtworkId = null;
    let points = [];

    // --- DOM要素の取得 ---
    const authSection = document.getElementById('auth-section');
    const mapSection = document.getElementById('map-section');
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const showRegisterLink = document.getElementById('show-register');
    const showLoginLink = document.getElementById('show-login');
    const authError = document.getElementById('auth-error');
    const loadingOverlay = document.getElementById('loading-overlay');

    // --- イベントリスナー ---
    document.addEventListener('DOMContentLoaded', () => {
        initMap();

        // フォーム切り替え
        showRegisterLink.addEventListener('click', (e) => { e.preventDefault(); toggleForms(); });
        showLoginLink.addEventListener('click', (e) => { e.preventDefault(); toggleForms(); });

        // ボタンのクリックイベント
        document.getElementById('register-button').addEventListener('click', handleRegister);
        document.getElementById('login-button').addEventListener('click', handleLogin);
        document.getElementById('logout-button').addEventListener('click', handleLogout);
        document.getElementById('start-button').addEventListener('click', handleStartDrawing);
        document.getElementById('stop-button').addEventListener('click', handleStopDrawing);
    });
    
    // --- UI制御 ---
    function toggleForms() {
        loginForm.classList.toggle('hidden');
        registerForm.classList.toggle('hidden');
        authError.textContent = '';
    }

    function showLoading() { loadingOverlay.classList.remove('hidden'); }
    function hideLoading() { loadingOverlay.classList.add('hidden'); }

    // --- API通信 ---
    async function apiFetch(endpoint, options = {}) {
        showLoading();
        try {
            const headers = { 'Content-Type': 'application/json', ...options.headers };
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...options,
                headers: headers
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || '不明なエラーが発生しました。');
            }
            return data;
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        } finally {
            hideLoading();
        }
    }

    // --- 認証関連のハンドラ ---
    async function handleRegister() {
        const name = document.getElementById('register-name').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        authError.textContent = '';

        try {
            const data = await apiFetch('/register.php', {
                method: 'POST',
                body: JSON.stringify({ user_name: name, email: email, password: password })
            });
            alert('登録が完了しました！ログインしてください。');
            toggleForms();
        } catch (error) {
            authError.textContent = error.message;
        }
    }
    
    async function handleLogin() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        authError.textContent = '';

        try {
            const data = await apiFetch('/login.php', {
                method: 'POST',
                body: JSON.stringify({ email: email, password: password })
            });
            token = data.token;
            authSection.classList.add('hidden');
            mapSection.classList.remove('hidden');
            document.getElementById('user-name-display').textContent = `ようこそ、${data.user.user_name}さん`;
        } catch (error) {
            authError.textContent = error.message;
        }
    }

    function handleLogout() {
        token = null;
        authSection.classList.remove('hidden');
        mapSection.classList.add('hidden');
        authError.textContent = '';
    }
    
    // --- 地図・お絵かき関連 ---
    function initMap() {
        map = L.map('map').setView([35.681, 139.767], 13); // 初期位置を東京駅に
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        
        // 現在地取得
        navigator.geolocation.getCurrentPosition(
            (position) => map.setView([position.coords.latitude, position.coords.longitude], 16),
            () => alert('現在地を取得できませんでした。')
        );

        polyline = L.polyline([], { color: '#14BE6F', weight: 5 }).addTo(map);
        
        map.on('mousemove', (e) => {
            if (isDrawing) {
                const newPoint = { latitude: e.latlng.lat, longitude: e.latlng.lng };
                points.push(newPoint);
                polyline.addLatLng(e.latlng);
            }
        });
    }

    async function handleStartDrawing() {
        try {
            const data = await apiFetch('/create_artwork.php', { method: 'POST' });
            currentArtworkId = data.artwork_id;
            isDrawing = true;
            points = [];
            polyline.setLatLngs([]);
            document.getElementById('start-button').disabled = true;
            document.getElementById('stop-button').disabled = false;
            document.getElementById('result-area').innerHTML = '';
            alert(`お絵かきを開始しました！(作品ID: ${currentArtworkId})`);
        } catch (error) {
            alert(`エラー: ${error.message}`);
        }
    }

    async function handleStopDrawing() {
        if (!isDrawing) return;
        isDrawing = false;
        
        try {
            const data = await apiFetch('/finalize_artwork.php', {
                method: 'POST',
                body: JSON.stringify({ artwork_id: currentArtworkId, points: points })
            });

            document.getElementById('start-button').disabled = false;
            document.getElementById('stop-button').disabled = true;
            
            const resultArea = document.getElementById('result-area');
            resultArea.innerHTML = `
                <h3 class="text-lg font-bold">作品が完成しました！</h3>
                <img src="http://${location.hostname}${data.image_url}" class="mt-2 border shadow-lg mx-auto" alt="完成した作品">
            `;
            alert('作品が完成し、保存されました！');

        } catch (error) {
            alert(`保存エラー: ${error.message}`);
        }
    }

</script>
</body>
</html>
