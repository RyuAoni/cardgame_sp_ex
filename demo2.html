<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>足跡百景 - お絵かきモード</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body { font-family: sans-serif; }
        #map { height: calc(100vh - 200px); width: 100%; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="text-white text-2xl">処理中...</div>
    </div>

    <div id="map-section">
        <header class="bg-white p-4 shadow-md">
            <div class="container mx-auto flex justify-center items-center">
                <h1 class="text-xl font-bold text-green-600">足跡百景 - お絵かきモード</h1>
            </div>
        </header>
        <div class="container mx-auto p-4">
            <div class="bg-white p-4 rounded-lg shadow-md">
                <div class="flex justify-center items-center space-x-4 mb-4">
                    <button id="start-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">お絵かきスタート</button>
                    <button id="stop-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded" disabled>ストップ</button>
                </div>
                <div id="map"></div>
                <div id="result-area" class="mt-4 text-center"></div>
            </div>
        </div>
    </div>

<script>
    // --- 設定項目 ---
    const API_BASE_URL = 'http://163.43.104.210/gps_art_app/api'; // サーバーのIPアドレス

    // --- グローバル変数 ---
    let map;
    let polyline;
    let isDrawing = false;
    let currentArtworkId = null;
    let points = [];

    // --- DOM要素の取得 ---
    const loadingOverlay = document.getElementById('loading-overlay');

    // --- イベントリスナー ---
    document.addEventListener('DOMContentLoaded', () => {
        initMap();
        document.getElementById('start-button').addEventListener('click', handleStartDrawing);
        document.getElementById('stop-button').addEventListener('click', handleStopDrawing);
    });
     
    // --- UI制御 ---
    function showLoading() { loadingOverlay.classList.remove('hidden'); }
    function hideLoading() { loadingOverlay.classList.add('hidden'); }

    // --- API通信 (認証処理なし) ---
    async function apiFetch(endpoint, options = {}) {
        showLoading();
        try {
            // ヘッダーには認証情報を含めず、送信データの形式を指定するだけ
            const headers = { 'Content-Type': 'application/json' };
             
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                ...options,
                headers: headers
            });

            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || '不明なエラーが発生しました。');
            }
            return data;
        } catch (error) {
            console.error('API Error:', error);
            throw error;
        } finally {
            hideLoading();
        }
    }
     
    // --- 地図・お絵かき関連 ---
    function initMap() {
        map = L.map('map').setView([35.681, 139.767], 13); // 初期位置: 東京駅
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
         
        // ユーザーの現在地を取得して地図の中心を移動
        navigator.geolocation.getCurrentPosition(
            (position) => map.setView([position.coords.latitude, position.coords.longitude], 16),
            () => console.warn('現在地を取得できませんでした。')
        );

        polyline = L.polyline([], { color: '#14BE6F', weight: 5 }).addTo(map);
         
        // マウスの動きでお絵かきする処理 (デモ用)
        map.on('mousemove', (e) => {
            if (isDrawing) {
                const newPoint = { latitude: e.latlng.lat, longitude: e.latlng.lng };
                points.push(newPoint);
                polyline.addLatLng(e.latlng);
            }
        });
    }

    // お絵かき開始ボタンの処理
    async function handleStartDrawing() {
        try {
            // ユーザー情報なしで新しい作品の作成をリクエスト
            const data = await apiFetch('/create_artwork.php', { method: 'POST' });
            currentArtworkId = data.artwork_id;
            isDrawing = true;
            points = [];
            polyline.setLatLngs([]); // 前の線を消去
            document.getElementById('start-button').disabled = true;
            document.getElementById('stop-button').disabled = false;
            document.getElementById('result-area').innerHTML = '';
            console.log(`お絵かきを開始しました (作品ID: ${currentArtworkId})`);
        } catch (error) {
            alert(`エラー: ${error.message}`);
        }
    }

    // ストップボタンの処理
    async function handleStopDrawing() {
        if (!isDrawing) return;
        isDrawing = false;
         
        try {
            // 作品IDと軌跡データをサーバーに送信して保存
            const data = await apiFetch('/finalize_artwork.php', {
                method: 'POST',
                body: JSON.stringify({ artwork_id: currentArtworkId, points: points })
            });

            document.getElementById('start-button').disabled = false;
            document.getElementById('stop-button').disabled = true;
             
            // 結果表示エリアに完成した画像を表示
            const resultArea = document.getElementById('result-area');
            resultArea.innerHTML = `
                <h3 class="text-lg font-bold">作品が完成しました！</h3>
                <img src="${data.image_url}" class="mt-2 border shadow-lg mx-auto" alt="完成した作品">
            `;
            alert('作品が完成し、保存されました！');

        } catch (error) {
            alert(`保存エラー: ${error.message}`);
        }
    }

</script>
</body>
</html>
